name: Tests

on:
  push:
  pull_request:
  release:

jobs:
  qt6:
    name: Build with Qt 6
    runs-on: ubuntu-22.04
    steps:

    - uses: actions/checkout@v4
      with:
          submodules: true
          fetch-depth: 0

    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Show Nix info
      run: nix --version

    - name: Build (Nix)
      timeout-minutes: 20
      run: nix build .#

    - name: Configure, build, and test (Nix dev shell)
      timeout-minutes: 20
      run: |
        nix develop -c bash -lc "
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo &&
          cmake --build build --verbose &&
          cmake --install build --prefix /tmp/staging &&
          ctest --test-dir build --output-on-failure
        "
