name: "Release"

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        type: string

jobs:
  build-linux:
    name: Build Linux binaries
    uses: ./.github/workflows/build_linux_tools.yml
    
  build-windows:
    name: Build Windows binaries  
    uses: ./.github/workflows/build_windows_tools.yml
    
  build-macos:
    name: Build macOS binaries
    uses: ./.github/workflows/build_macos_tools.yml

  upload-release-assets:
    name: Upload release assets
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: tbc-tools_linux_x86_64
          path: ./artifacts/

      - name: Download Linux ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: tbc-tools_linux_arm64
          path: ./artifacts/
          
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: tbc-tools_windows_x86_64
          path: ./artifacts/windows/

      - name: Download Windows ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: tbc-tools_windows_arm64
          path: ./artifacts/windows-arm/
          
      - name: Download macOS x86_64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: tbc-tools_macos_x86_64
          path: ./artifacts/
          
      - name: Download macOS arm64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: tbc-tools_macos_arm64
          path: ./artifacts/

      - name: Create Windows release archive
        run: |
          cd artifacts/windows
          zip -r ../tbc-tools_windows_x86_64.zip .
          cd ../..

      - name: Create Windows ARM64 release archive
        run: |
          cd artifacts/windows-arm
          zip -r ../tbc-tools_windows_arm64.zip .
          cd ../..

      - name: Upload Linux release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/tbc-tools_linux_x86_64.tar.xz
          asset_name: tbc-tools_linux_x86_64.tar.xz
          asset_content_type: application/x-xz

      - name: Upload Linux ARM64 release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/tbc-tools_linux_arm64.tar.xz
          asset_name: tbc-tools_linux_arm64.tar.xz
          asset_content_type: application/x-xz

      - name: Upload Windows release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/tbc-tools_windows_x86_64.zip
          asset_name: tbc-tools_windows_x86_64.zip
          asset_content_type: application/zip

      - name: Upload Windows ARM64 release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/tbc-tools_windows_arm64.zip
          asset_name: tbc-tools_windows_arm64.zip
          asset_content_type: application/zip

      - name: Upload macOS x86_64 release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/tbc-tools_x86_64.dmg
          asset_name: tbc-tools_macos_x86_64.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload macOS arm64 release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/tbc-tools_arm64.dmg
          asset_name: tbc-tools_macos_arm64.dmg
          asset_content_type: application/x-apple-diskimage