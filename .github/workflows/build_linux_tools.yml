name: "Build Linux tools"

on:
  workflow_dispatch:
  release:
    types: [created]

env:
  APPIMAGETOOL_URL: "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"

jobs:
  build-tbc-tools:
    name: Build tbc-tools (x86_64)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Configure, build, and install to AppDir (Nix dev shell)
        run: |
          nix develop -c bash -lc "
            cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release &&
            cmake --build build --verbose &&
            cmake --install build --prefix AppDir/usr
          "

      - name: Copy scripts into AppDir
        run: |
          mkdir -p AppDir/usr/bin
          find scripts -maxdepth 1 -type f -executable -exec cp {} AppDir/usr/bin/ \; || true

      - name: Create desktop file and AppRun
        run: |
          mkdir -p AppDir
          cp AppDir/usr/share/icons/hicolor/128x128/apps/ld-analyse.png AppDir/ld-analyse.png
          
          cat > AppDir/ld-analyse.desktop << 'EOF'
[Desktop Entry]
Type=Application
NoDisplay=false
Terminal=false
Exec=ld-analyse
Icon=ld-analyse
Name=ld-analyse
MimeType=application/video-tbc
Comment=LaserDisc TBC file analyzer
Categories=AudioVideo;Video;Utility;
EOF
          
          cat > AppDir/AppRun << 'EOF'
#!/bin/sh
set -eu
APPDIR="$(dirname "$(readlink -f "$0")")"
BIN_DIR="$APPDIR/usr/bin"
export LD_LIBRARY_PATH="$APPDIR/usr/lib:${LD_LIBRARY_PATH:-}"
export QT_PLUGIN_PATH="$APPDIR/usr/plugins:${QT_PLUGIN_PATH:-}"

if [ "$#" -ge 1 ] && [ -x "$BIN_DIR/$1" ]; then
  TOOL="$1"
  shift
  exec "$BIN_DIR/$TOOL" "$@"
fi

exec "$BIN_DIR/ld-analyse" "$@"
EOF
          chmod +x AppDir/AppRun

      - name: Bundle runtime libraries and Qt plugins into AppDir
        run: |
          mkdir -p AppDir/usr/lib AppDir/usr/plugins
          
          find AppDir/usr/bin -type f -executable -print0 | xargs -0 -I{} ldd {} 2>/dev/null | \
            awk '/=> \// {print $3} /^\// {print $1}' | sort -u > /tmp/libs.txt
          
          while read -r lib; do
            [ -z "$lib" ] && continue
            case "$lib" in
              */ld-linux*|*/ld-linux*.so*|*/linux-vdso.so*|*/libc.so*|*/libpthread.so*|*/librt.so*|*/libm.so*|*/libdl.so*|*/libutil.so*)
                continue
                ;;
            esac
            
            if [ -f "$lib" ]; then
              cp -aL "$lib" AppDir/usr/lib/ 2>/dev/null || true
            fi
          done < /tmp/libs.txt
          
          nix develop -c bash -lc '
            LIBQXCB=$(find /nix/store -name "libqxcb.so" 2>/dev/null | head -1)
            if [ -n "$LIBQXCB" ]; then
              QT_PLUGINS=$(dirname $(dirname "$LIBQXCB"))
              cp -r "$QT_PLUGINS"/* AppDir/usr/plugins/ 2>/dev/null || true
            fi
          '
          
          chmod -R u+w AppDir/usr/lib AppDir/usr/plugins 2>/dev/null || true
          echo "Bundled $(ls -1 AppDir/usr/lib/*.so* 2>/dev/null | wc -l) .so files"

      - name: Download appimagetool and build AppImage
        run: |
          curl -LJO ${{ env.APPIMAGETOOL_URL }}
          chmod +x appimagetool-x86_64.AppImage
          
          ./appimagetool-x86_64.AppImage AppDir tbc-tools-x86_64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: tbc-tools_linux_x86_64_appimage
          path: tbc-tools-x86_64.AppImage
          if-no-files-found: error
