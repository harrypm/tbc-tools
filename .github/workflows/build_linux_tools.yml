name: "Build Linux tools"

on:
  workflow_dispatch:
  release:
    types: [created]

env:
  APPIMAGE_FILE: "linuxdeploy-x86_64.AppImage"
  APPIMAGE_URL: "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
  APPIMAGE_PLUGIN_FILE: "linuxdeploy-plugin-appimage-x86_64.AppImage"
  APPIMAGE_PLUGIN_URL: "https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage"
  APPIMAGE_QT_FILE: "linuxdeploy-plugin-qt-x86_64.AppImage"
  APPIMAGE_QT_URL: "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"

jobs:
  build-tbc-tools:
    name: Build tbc-tools (x86_64)
    runs-on: ubuntu-latest
    container:
      image: oraclelinux:8
      options: --user 0 --cap-add SYS_ADMIN --cap-add MKNOD --device /dev/fuse:mrw --security-opt apparmor:unconfined --privileged

    steps:
      - name: Set up DNF download cache
        id: dnf-cache
        uses: actions/cache@v3
        with:
          path: /var/cache/dnf
          key: dnfcache
          
      - name: Setup environment
        run: |
          dnf install --assumeyes --nogpgcheck https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E %rhel).noarch.rpm
          dnf install --assumeyes --nogpgcheck https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-$(rpm -E %rhel).noarch.rpm
          FORCE_DNF=1 /usr/bin/crb enable
          dnf --assumeyes install sudo git file xz ca-certificates libglvnd-opengl libglvnd-glx libglvnd-egl fftw-devel ffmpeg-devel ffmpeg pkgconf-pkg-config make cmake gcc-c++
          update-ca-trust
          mkdir -p -m 0755 /nix
          chown root /nix
          groupadd --system nixbld || true
          for i in $(seq 1 32); do
            useradd --system --gid nixbld --groups nixbld --no-create-home --home-dir /var/empty --shell /sbin/nologin "nixbld$i" || true
            usermod --append --groups nixbld "nixbld$i" || true
          done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - name: Install Nix
        shell: bash
        run: |
          curl -L https://nixos.org/nix/install | sh -s -- --no-daemon --yes
          echo "/nix/var/nix/profiles/default/bin" >> "$GITHUB_PATH"
          echo "/root/.nix-profile/bin" >> "$GITHUB_PATH"
          echo "$HOME/.nix-profile/bin" >> "$GITHUB_PATH"
          echo "NIX_CONFIG=experimental-features = nix-command flakes" >> "$GITHUB_ENV"
          echo "NIX_PATH=nixpkgs=channel:nixos-unstable" >> "$GITHUB_ENV"
          echo "NIX_SSL_CERT_FILE=/etc/pki/tls/certs/ca-bundle.crt" >> "$GITHUB_ENV"

      - name: Create release directory
        run: mkdir release/

      - name: Build with Nix
        run: |
          export HOME=/root
          export PATH="/nix/var/nix/profiles/default/bin:/root/.nix-profile/bin:$HOME/.nix-profile/bin:$PATH"
          chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE"
          nix build .#
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          cp -a result/bin/. AppDir/usr/bin/
          cp -a result/lib/. AppDir/usr/lib/ || true

      - name: Download linuxdeploy and build AppImage
        run: |
          curl -LJO ${{ env.APPIMAGE_URL }}
          curl -LJO ${{ env.APPIMAGE_PLUGIN_URL }}
          curl -LJO ${{ env.APPIMAGE_QT_URL }}

          chmod +x ${{ env.APPIMAGE_FILE }} ${{ env.APPIMAGE_PLUGIN_FILE }} ${{ env.APPIMAGE_QT_FILE }}
          export APPIMAGE_EXTRACT_AND_RUN=1
          QMAKE="$(find /nix/store -type f -path '*/bin/qmake' | head -n 1 || true)"
          if [ -z "$QMAKE" ]; then
            QMAKE="$(find /nix/store -type f -path '*/bin/qmake6' | head -n 1 || true)"
          fi
          if [ -n "$QMAKE" ]; then
            export QMAKE
            export PATH="$(dirname "$QMAKE"):$PATH"
          fi

          EXTRA_QT_MODULES="core;gui;opengl;widgets;sql" ./${{ env.APPIMAGE_QT_FILE }} --appdir AppDir

          # Create minimal desktop file
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/tbc-tools.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=TBC Tools
          Comment=Time Base Corrected video analysis tools
          Exec=ld-analyse
          Icon=tbc-tools
          Categories=AudioVideo;Video;
          EOF
          # Provide application icon for desktop entry
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp src/ld-analyse/Graphics/256-analyse.png AppDir/usr/share/icons/hicolor/256x256/apps/tbc-tools.png

          ./${{ env.APPIMAGE_FILE }} \
          --desktop-file AppDir/usr/share/applications/tbc-tools.desktop \
          --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/tbc-tools.png \
          --appdir AppDir/ \
          --output appimage
          APPIMAGE_OUT="$(find . -maxdepth 1 -type f -name '*.AppImage' ! -name 'linuxdeploy*.AppImage' | head -n 1)"
          if [ -z "$APPIMAGE_OUT" ]; then
            echo "No generated AppImage found in workspace root"
            ls -1 *.AppImage || true
            exit 1
          fi
          cp "$APPIMAGE_OUT" release/tbc-tools-x86_64.AppImage

      - name: Copy scripts
        run: find scripts -maxdepth 1 -type f -executable -exec cp {} release/ \; || true

      - name: Create release archive
        run: tar -cvJSf tbc-tools_linux_x86_64.tar.xz --transform s/release/tbc-tools/ release/

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: tbc-tools_linux_x86_64
          path: tbc-tools_linux_x86_64.tar.xz
          if-no-files-found: error