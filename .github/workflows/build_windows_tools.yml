name: "Build Windows tools"

on:
  workflow_dispatch:
  release:
    types: [created]

env:
  # External tools to be bundled
  FFMPEG_FILE: "ffmpeg-8.0.1-full_build.zip"
  FFMPEG_PATH: "ffmpeg-8.0.1-full_build"
  FFMPEG_URL: "https://github.com/GyanD/codexffmpeg/releases/download/8.0.1/ffmpeg-8.0.1-full_build.zip"
  FLAC_FILE: "flac-1.5.0-win.zip"
  FLAC_PATH: "flac-1.5.0-win"
  FLAC_URL: "https://ftp.osuosl.org/pub/xiph/releases/flac/flac-1.5.0-win.zip"

jobs:
  build-tbc-tools:
    name: Build tbc-tools (x86_64)
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - uses: lukka/get-cmake@latest
        with:
            cmakeVersion: "^3.31.6" # Need to pin to cmake 3.x until fftw3 is updated to support cmake 4.x.

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "d30fdf55cfca16e12bc3ad99cbc615997014b61b"
          # Prevent false-positive "File not found" warnings from broad default log regexes.
          logCollectionRegExps: "a^"
      - name: Initialize repository-contained vcpkg cache
        run: |
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\ci\cache\vcpkg\windows-x64" | Out-Null
          "VCPKG_BINARY_SOURCES=clear;files,${{ github.workspace }}\ci\cache\vcpkg\windows-x64,readwrite" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Reassemble chunked repository cache archives
        run: |
          $cacheRoot = "${{ github.workspace }}\ci\cache\vcpkg\windows-x64"
          Get-ChildItem -Recurse -Path $cacheRoot -Filter "*.zip.part.001" | ForEach-Object {
            $zipPath = $_.FullName -replace '\.part\.001$',''
            if (Test-Path $zipPath) {
              return
            }
            $parts = Get-ChildItem -Path "$zipPath.part.*" | Sort-Object Name
            if ($parts.Count -eq 0) {
              return
            }
            cmd /c "copy /b `"$zipPath.part.*`" `"$zipPath`" >nul"
          }

      - name: Run CMake
        uses: lukka/run-cmake@v10
        with:
          configurePreset: vcpkg
          configurePresetAdditionalArgs: "['-DCMAKE_BUILD_TYPE=Release', '-DUSE_QT_VERSION=6', '-DBUILD_PYTHON=false', '-DVCPKG_APPLOCAL_DEPS=ON', '-DBUILD_TESTING=OFF',]"
          buildPreset: vcpkg
          buildPresetAdditionalArgs: "['--config Release']"
          # Prevent false-positive "File not found" warnings from broad default log regexes.
          logCollectionRegExps: "a^"

      - name: Create release directory
        run: New-Item -ItemType Directory -Path release

      - name: Copy binaries to release directory
        run: Get-ChildItem -Recurse -Path build\\bin\\* -Include *.exe, *.dll | Copy-Item -Destination release\\

      - name: Copy Qt plugins to release directory
        run: Copy-Item -Recurse -Exclude *.pdb -Path build\\vcpkg_installed\\x64-windows\\Qt6\\plugins\\* -Destination release\\

      - name: Copy license files to release directory
        run: |
          New-Item -ItemType Directory -Path release\\LICENSES
          "brotli", `
          "bzip2", `
          "double-conversion", `
          "fftw3", `
          "freetype", `
          "getopt-win32", `
          "harfbuzz", `
          "icu", `
          "libpng", `
          "openssl", `
          "pcre2", `
          "qtbase", `
          "sqlite3", `
          "zlib", `
          "zstd" | ForEach-Object {
            $copyright = "build\\vcpkg_installed\\x64-windows\\share\\$($_)\\copyright"
            if (Test-Path $copyright) {
              Copy-Item -Path $copyright -Destination release\\LICENSES\\copyright-$($_)
            }
          }
          if (Test-Path release\\LICENSES\\copyright-qtbase) {
            Rename-Item -Path release\\LICENSES\\copyright-qtbase -NewName copyright-qt6
          }

      - name: Copy scripts to release directory (if they exist)
        run: |
          if (Test-Path ".\\scripts\\Windows\\*.bat") {
            Copy-Item .\\scripts\\Windows\\*.bat -Destination release\\
          }

      - name: Download and copy FFmpeg to release directory
        run: |
          Invoke-WebRequest "${{ env.FFMPEG_URL }}" -OutFile ffmpeg.zip
          Expand-Archive .\\ffmpeg.zip -DestinationPath .
          Copy-Item -Path .\\${{ env.FFMPEG_PATH}}\\bin\\ffmpeg.exe -Destination release\\
          Copy-Item -Path .\\${{ env.FFMPEG_PATH}}\\LICENSE -Destination release\\LICENSES\\copyright-ffmpeg

      - name: Download and copy FLAC to release directory
        run: |
          Invoke-WebRequest "${{ env.FLAC_URL }}" -OutFile flac.zip
          Expand-Archive .\\flac.zip -DestinationPath .
          Copy-Item -Path .\\${{ env.FLAC_PATH }}\\Win64\\* -Destination release\\
          Copy-Item -Path .\\${{ env.FLAC_PATH }}\\COPYING.GPL -Destination release\\LICENSES\\copyright-flac

      - name: Copy project license
        run: Copy-Item -Path .\\LICENSE -Destination release\\LICENSES\\copyright-tbc-tools
      - name: Split oversized repository cache archives for git compatibility
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
        run: |
          $cacheRoot = "${{ github.workspace }}\ci\cache\vcpkg\windows-x64"
          $chunkSize = 95MB
          Get-ChildItem -Recurse -Path $cacheRoot -Filter "*.zip" | Where-Object { $_.Length -gt $chunkSize } | ForEach-Object {
            $zipPath = $_.FullName
            Remove-Item -Force -ErrorAction SilentlyContinue "$zipPath.part.*"
            $stream = [System.IO.File]::OpenRead($zipPath)
            try {
              $buffer = New-Object byte[] $chunkSize
              $index = 1
              while (($read = $stream.Read($buffer, 0, $buffer.Length)) -gt 0) {
                $partPath = "{0}.part.{1:000}" -f $zipPath, $index
                $partStream = [System.IO.File]::Open($partPath, [System.IO.FileMode]::Create, [System.IO.FileAccess]::Write)
                try {
                  $partStream.Write($buffer, 0, $read)
                } finally {
                  $partStream.Close()
                }
                $index++
              }
            } finally {
              $stream.Close()
            }
            Remove-Item -Force $zipPath
          }
      - name: Commit updated repository cache (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config http.version HTTP/1.1
          git config http.postBuffer 524288000
          git add ci/cache/vcpkg/windows-x64
          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No repository cache updates to commit."
            exit 0
          }
          git commit -m "Update Windows vcpkg repository cache [skip ci]"
          $pushed = $false
          for ($attempt = 1; $attempt -le 5; $attempt++) {
            git pull --rebase origin main
            if ($LASTEXITCODE -ne 0) {
              Write-Warning "Rebase attempt $attempt failed; retrying..."
              Start-Sleep -Seconds (10 * $attempt)
              continue
            }
            git push origin HEAD:main
            if ($LASTEXITCODE -eq 0) {
              $pushed = $true
              break
            }
            Write-Warning "Push attempt $attempt failed; retrying..."
            Start-Sleep -Seconds (10 * $attempt)
          }
          if (-not $pushed) {
            Write-Warning "Could not push cache update after retries."
            exit 0
          }

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: tbc-tools_windows_x86_64
          path: release
          if-no-files-found: error